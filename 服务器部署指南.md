# EdGoing项目服务器部署指南

本文档提供了在服务器上从GitHub克隆并部署EdGoing项目的详细步骤，确保包含所有数据和内容模块，以便前端页面正常显示。

## 一、服务器环境准备

### 1. 安装必要的软件

```bash
# CentOS系统
yum update -y
yum install -y git curl wget nodejs npm

# Ubuntu/Debian系统
apt-get update
apt-get install -y git curl wget
```

### 2. 安装Node.js和npm

推荐使用nvm安装Node.js 16.x或更高版本：

```bash
# 安装nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
source ~/.bashrc

# 安装Node.js 16
nvm install 16
nvm use 16

# 验证安装
node -v
npm -v
```

### 3. 安装PM2（用于进程管理）

```bash
npm install -g pm2
```

## 二、克隆项目

### 1. 从GitHub克隆项目

```bash
# 创建项目目录
mkdir -p /www/wwwroot
cd /www/wwwroot

# 克隆项目
git clone https://github.com/beilinli023/edgoing-project.git edgoing
cd edgoing
```

## 三、安装项目依赖

### 1. 安装根项目依赖

```bash
npm install
```

### 2. 安装Strapi依赖

```bash
cd my-strapi-backend
npm install
cd ..
```

### 3. 安装Express中间层依赖

```bash
cd server-express
npm install
cd ..
```

## 四、配置环境变量

### 1. 配置Strapi环境

```bash
# 创建Strapi环境配置
cp my-strapi-backend/.env.example my-strapi-backend/.env
```

编辑`my-strapi-backend/.env`文件，根据您的需求配置数据库：

#### SQLite配置（简单，适合小型项目）

```
DATABASE_CLIENT=sqlite
DATABASE_FILENAME=.tmp/data.db
```

#### MySQL配置（推荐用于生产环境）

```
DATABASE_CLIENT=mysql
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_NAME=edgoing_db
DATABASE_USERNAME=edgoing_user
DATABASE_PASSWORD=your-secure-password
DATABASE_SSL=false
```

如果使用MySQL，请确保已创建数据库和用户：

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE edgoing_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'edgoing_user'@'localhost' IDENTIFIED BY 'your-secure-password';
GRANT ALL PRIVILEGES ON edgoing_db.* TO 'edgoing_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2. 配置项目根目录环境变量

```bash
cp .env.example .env
```

### 3. 配置Express中间层环境变量

```bash
cp server-express/.env.example server-express/.env
```

## 五、启动Strapi并生成API Token

### 1. 构建并启动Strapi

```bash
cd my-strapi-backend
npm run build
npm run start
```

### 2. 创建管理员账户

在浏览器中访问`http://your-server-ip:1337/admin`，按照提示创建管理员账户。

### 3. 生成API Token

1. 登录Strapi管理面板
2. 进入"设置" -> "API Tokens"
3. 点击"创建新的API Token"
4. 名称：填写"Frontend Access"
5. 类型：选择"Full access"
6. 点击"保存"
7. 复制生成的Token

### 4. 配置API Token

编辑以下文件，添加您刚刚生成的API Token：

1. 编辑根目录的`.env`文件：
   ```
   STRAPI_API_TOKEN=your-token-here
   ```

2. 编辑`server-express/.env`文件：
   ```
   STRAPI_API_TOKEN=your-token-here
   ```

## 六、导入数据

### 1. 恢复上传的文件

```bash
# 确保上传目录存在
mkdir -p my-strapi-backend/public/uploads

# 复制导出的文件
cp -r strapi-uploads-export/* my-strapi-backend/public/uploads/
```

### 2. 导入Strapi数据

```bash
# 确保Strapi正在运行
node import-strapi-data.mjs
```

## 七、构建和启动项目

### 1. 构建前端

```bash
npm run build
```

### 2. 使用PM2启动所有服务

```bash
pm2 start ecosystem.config.js
```

### 3. 保存PM2配置并设置开机自启

```bash
pm2 save
pm2 startup
```

## 八、配置Nginx（可选，用于生产环境）

如果您想使用Nginx作为反向代理，可以使用以下配置：

```bash
# 安装Nginx
# CentOS
yum install -y nginx

# Ubuntu/Debian
apt-get install -y nginx
```

创建Nginx配置文件：

```bash
# CentOS
vi /etc/nginx/conf.d/edgoing.conf

# Ubuntu/Debian
vi /etc/nginx/sites-available/edgoing
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /www/wwwroot/edgoing/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API代理到Express中间层
    location /api/ {
        proxy_pass http://localhost:3001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 代理到Strapi
    location /strapi/ {
        proxy_pass http://localhost:1337/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

在Ubuntu/Debian上，创建符号链接并重启Nginx：

```bash
ln -s /etc/nginx/sites-available/edgoing /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx
```

在CentOS上，直接重启Nginx：

```bash
nginx -t
systemctl restart nginx
```

## 九、验证部署

启动后，各服务的访问地址为：

- 前端应用：http://your-server-ip:8083
- Strapi管理面板：http://your-server-ip:1337/admin
- Express API：http://your-server-ip:3001

如果配置了Nginx，可以通过域名访问：

- 前端应用：http://your-domain.com
- Strapi管理面板：http://your-domain.com/strapi/admin
- Express API：http://your-domain.com/api

## 十、常见问题解决

### 1. 端口被占用

检查是否有其他应用占用了1337、3001或8083端口：

```bash
netstat -tulpn | grep LISTEN
```

如果端口被占用，可以修改相应服务的配置文件中的端口。

### 2. 数据导入失败

- 检查Strapi API Token是否正确配置
- 确保Strapi服务正在运行
- 查看导入脚本的错误日志

### 3. 服务启动失败

检查PM2日志：

```bash
pm2 logs
```

### 4. 前端页面报错

- 确保Strapi数据已成功导入
- 确保API Token配置正确
- 检查浏览器控制台的错误信息

## 十一、更新部署

当需要更新部署时，可以使用以下步骤：

```bash
# 进入项目目录
cd /www/wwwroot/edgoing

# 拉取最新代码
git pull

# 安装依赖并构建
npm install
npm run build
cd my-strapi-backend
npm install
npm run build
cd ..

# 重启服务
pm2 restart all
```
