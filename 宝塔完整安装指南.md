# EdGoing项目宝塔完整安装指南

本文档提供了在宝塔面板上完整安装和配置EdGoing项目的详细步骤，包括环境准备、依赖安装、数据导入和Strapi API Token配置等内容。

## 一、环境准备

### 1. 宝塔面板安装

如果您尚未安装宝塔面板，请按照以下步骤安装：

1. 使用SSH连接到您的服务器
2. 运行以下命令安装宝塔面板（CentOS系统）：
   ```bash
   yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
   ```
   
   或者Ubuntu/Debian系统：
   ```bash
   wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
   ```

3. 安装完成后，记录下显示的宝塔面板访问地址、用户名和密码
4. 在浏览器中访问宝塔面板地址，使用提供的用户名和密码登录

### 2. 安装必要的软件

在宝塔面板中安装以下软件：

1. 登录宝塔面板
2. 进入"软件商店"页面
3. 安装以下软件：
   - Nginx（推荐1.18+）
   - MySQL（推荐5.7+）
   - Node.js（推荐16.x+）
   - PM2管理器
   - Git

安装Node.js和PM2的步骤：
1. 在宝塔面板中，进入"软件商店" -> "Node.js版本管理器"
2. 安装Node.js 16.x或更高版本
3. 安装完成后，使用以下命令安装PM2：
   ```bash
   npm install -g pm2
   ```

## 二、项目部署

### 1. 创建网站和数据库

1. 在宝塔面板中，进入"网站"页面，点击"添加站点"
2. 填写域名信息（例如：your-domain.com）
3. 选择PHP版本为"纯静态"
4. 创建数据库：
   - 数据库类型：MySQL
   - 数据库名：edgoing_db
   - 用户名：edgoing_user
   - 密码：设置一个安全的密码（请记住此密码）
5. 点击"提交"创建站点

### 2. 获取项目代码

1. 在宝塔面板中，进入"文件"页面
2. 导航到网站根目录（通常是/www/wwwroot/）
3. 删除默认创建的网站目录
4. 使用终端执行以下命令：
   ```bash
   cd /www/wwwroot/
   git clone https://github.com/your-username/edgoing.git your-domain.com
   cd your-domain.com
   ```

### 3. 安装项目依赖

1. 安装项目根目录依赖：
   ```bash
   npm install
   ```

2. 安装Strapi依赖：
   ```bash
   cd my-strapi-backend
   npm install
   cd ..
   ```

3. 安装Express中间层依赖：
   ```bash
   cd server-express
   npm install
   cd ..
   ```

## 三、配置环境变量

### 1. 配置Strapi环境

1. 创建Strapi环境配置文件：
   ```bash
   cp my-strapi-backend/.env.production.example my-strapi-backend/.env
   ```

2. 编辑`my-strapi-backend/.env`文件，填入数据库信息和其他必要配置：
   ```
   # 数据库配置
   DATABASE_CLIENT=mysql
   DATABASE_HOST=localhost
   DATABASE_PORT=3306
   DATABASE_NAME=edgoing_db
   DATABASE_USERNAME=edgoing_user
   DATABASE_PASSWORD=your-secure-password  # 使用您在创建数据库时设置的密码
   DATABASE_SSL=false
   
   # 安全密钥配置（可以保留示例值，或者生成新的随机值）
   APP_KEYS=your-app-keys-here
   API_TOKEN_SALT=your-api-token-salt-here
   ADMIN_JWT_SECRET=your-admin-jwt-secret-here
   TRANSFER_TOKEN_SALT=your-transfer-token-salt-here
   JWT_SECRET=your-jwt-secret-here
   
   # SMTP配置（如果需要发送邮件）
   SMTP_USER=your-email@example.com
   SMTP_PASS=your-email-password-or-app-password
   
   # 管理员邮箱配置
   ADMIN_EMAILS=admin@your-domain.com
   ```

### 2. 生成Strapi API Token

1. 构建并启动Strapi：
   ```bash
   cd my-strapi-backend
   npm run build
   npm run start
   ```

2. 在浏览器中访问Strapi管理面板：`http://your-domain.com:1337/admin`

3. 首次访问时，创建管理员账户：
   - 填写名称、电子邮件和密码
   - 点击"创建账户"

4. 登录后，生成API Token：
   - 在左侧菜单中，点击"设置"
   - 点击"API Tokens"
   - 点击"创建新的API Token"
   - 名称：填写一个描述性名称，如"Frontend Access"
   - 类型：选择"Full access"或根据需要选择适当的权限
   - 点击"保存"
   - 复制生成的API Token（这个Token只会显示一次，请务必保存）

### 3. 配置前端和Express中间层环境

1. 创建生产环境配置文件：
   ```bash
   cp .env.production.example .env.production
   ```

2. 编辑`.env.production`文件，填入正确的域名、API地址和Strapi API Token：
   ```
   # API配置
   VITE_API_URL=http://your-domain.com/api
   VITE_STRAPI_URL=http://your-domain.com:1337
   VITE_PUBLIC_URL=http://your-domain.com
   
   # 关闭模拟数据和文件系统，仅使用Strapi API
   VITE_USE_MOCK_DATA=false
   VITE_USE_FILE_SYSTEM=false
   VITE_STATIC_MODE=false
   
   # Strapi API Token（填入您刚才生成的Token）
   STRAPI_API_TOKEN=your-strapi-api-token
   
   # Strapi API URL
   STRAPI_API_URL=http://localhost:1337
   
   # 代理服务器端口
   PROXY_PORT=3001
   ```

## 四、数据导入

### 1. 准备数据导入

1. 如果您有现有数据需要导入，请确保数据文件已上传到服务器
2. 数据文件可以是JSON格式或SQL格式

### 2. 导入数据到Strapi

#### 方法一：使用Strapi管理面板导入

1. 登录Strapi管理面板：`http://your-domain.com:1337/admin`
2. 对于每种内容类型，可以通过界面手动创建或导入数据

#### 方法二：使用导入脚本（适用于JSON数据）

1. 将数据文件放在项目根目录下
2. 使用项目中的导入脚本导入数据，例如：
   ```bash
   node import-data-to-strapi.mjs
   ```

#### 方法三：使用MySQL导入（适用于SQL数据）

1. 在宝塔面板中，进入"数据库"页面
2. 找到您的数据库（edgoing_db）
3. 点击"导入"
4. 选择SQL文件并导入

## 五、构建和启动项目

### 1. 构建前端和Strapi

1. 构建前端：
   ```bash
   npm run build:prod
   ```

2. 构建Strapi（如果尚未构建）：
   ```bash
   cd my-strapi-backend
   npm run build
   cd ..
   ```

### 2. 使用PM2启动服务

1. 启动所有服务：
   ```bash
   pm2 start ecosystem.config.js
   ```

2. 保存PM2配置：
   ```bash
   pm2 save
   ```

3. 设置PM2开机自启：
   ```bash
   pm2 startup
   ```

## 六、配置Nginx

1. 在宝塔面板中，进入"网站"页面
2. 找到您的站点，点击"设置"
3. 点击"配置文件"
4. 将以下配置复制到Nginx配置中：

```nginx
# 前端应用配置
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS（如果已配置SSL）
    # return 301 https://$host$request_uri;
    
    # 前端静态文件
    root /www/wwwroot/your-domain.com/dist;
    index index.html;
    
    # 处理SPA路由
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理到Express中间层
    location /api/ {
        proxy_pass http://localhost:3001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 代理到Strapi
    location /strapi/ {
        proxy_pass http://localhost:1337/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 错误页面
    error_page 404 /index.html;
    
    # 日志
    access_log /www/wwwlogs/your-domain.com.log;
    error_log /www/wwwlogs/your-domain.com.error.log;
}
```

5. 点击"保存"

## 七、配置SSL（可选）

1. 在宝塔面板中，进入"网站"页面
2. 找到您的站点，点击"设置"
3. 点击"SSL"
4. 选择"Let's Encrypt"，填写您的邮箱
5. 勾选需要的域名，点击"申请"
6. 证书申请成功后，点击"强制HTTPS"

## 八、验证安装

1. 访问前端应用：`http://your-domain.com`
2. 访问Strapi管理面板：`http://your-domain.com:1337/admin`
3. 测试API：`http://your-domain.com/api`

## 九、常见问题解决

### 1. 端口被占用

- 检查是否有其他应用占用了1337、3001或8083端口
- 可以使用以下命令查看端口占用情况：
  ```bash
  netstat -tulpn | grep LISTEN
  ```
- 可以在`ecosystem.config.js`中修改端口配置

### 2. 数据库连接失败

- 检查数据库配置是否正确
- 确保MySQL服务正在运行
- 检查数据库用户权限
- 可以使用以下命令测试数据库连接：
  ```bash
  mysql -u edgoing_user -p -h localhost edgoing_db
  ```

### 3. Nginx配置错误

- 检查Nginx错误日志：`/www/wwwlogs/nginx_error.log`
- 使用以下命令测试Nginx配置：
  ```bash
  nginx -t
  ```

### 4. Strapi启动失败

- 检查Strapi日志：`pm2 logs strapi`
- 确保数据库配置正确
- 尝试重新构建Strapi：
  ```bash
  cd my-strapi-backend
  npm run build
  cd ..
  pm2 restart strapi
  ```

### 5. Express中间层启动失败

- 检查Express日志：`pm2 logs express`
- 确保Strapi已经启动
- 确保Strapi API Token配置正确

## 十、备份与维护

### 1. 数据库备份

- 在宝塔面板中，进入"数据库"页面
- 找到您的数据库，点击"备份"
- 设置定时备份计划

### 2. 文件备份

- 在宝塔面板中，进入"文件"页面
- 选择项目目录，点击"压缩"
- 下载压缩文件作为备份

### 3. 更新部署

当需要更新部署时，可以使用以下步骤：

1. 拉取最新代码：
   ```bash
   cd /www/wwwroot/your-domain.com
   git pull
   ```

2. 安装依赖并构建：
   ```bash
   npm install
   npm run build:prod
   cd my-strapi-backend
   npm install
   npm run build
   cd ..
   ```

3. 重启服务：
   ```bash
   pm2 restart all
   ```

## 十一、安全建议

1. 配置防火墙，只开放必要的端口（80、443）
2. 使用强密码保护数据库和宝塔面板
3. 定期更新系统和应用程序
4. 配置SSL证书，使用HTTPS加密传输
5. 定期备份数据
6. 限制Strapi管理面板的访问IP
